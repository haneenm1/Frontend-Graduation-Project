<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>عرض الخطة العلاجية</title>
  <style>

    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

    body {
      font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: ltr;
      background: linear-gradient(135deg, #e9f0fb, #f9faff);
      margin: 0;
      padding: 30px 20px;
      color: #34495e;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      max-width: 900px;
      width: 100%;
      background: #ffffffdd;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(52, 73, 94, 0.15);
      padding: 40px 50px 50px 50px;
      transition: box-shadow 0.3s ease;
    }
    .container:hover {
      box-shadow: 0 20px 45px rgba(52, 73, 94, 0.25);
    }

    /* شعار أنيق */
    .logo-container {
      text-align: center;
      margin-bottom: 40px;
    }
    .logo {
      font-size: 2.8rem;
      font-weight: 700;
      color: #2c3e50;
      letter-spacing: 2px;
      text-shadow: 0 2px 6px rgba(46, 134, 193, 0.3);
      user-select: none;
    }

    .logo-img {
      max-width: 130px;
      margin: 15px auto 0;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(41, 128, 185, 0.4));
    }

    /* معلومات الطفل */
    #childInfo {
      background-color: #f0f6fc;
      border-radius: 12px;
      padding: 20px 25px;
      margin-bottom: 35px;
      box-shadow: inset 0 0 15px rgba(41, 128, 185, 0.1);
      font-size: 1.15rem;
      color: #1b263b;
      line-height: 1.6;
      letter-spacing: 0.3px;
    }
    #childInfo strong {
      font-size: 1.3rem;
      color: #2980b9;
      display: block;
      margin-bottom: 12px;
      letter-spacing: 0.8px;
    }
    #childInfo span {
      font-weight: 600;
      color: #34495e;
      margin-left: 6px;
    }

    /* العناوين الرئيسية */
    h2, h3, h4 {
      font-weight: 700;
      color: #2c3e50;
      margin: 0 0 18px 0;
      letter-spacing: 0.8px;
    }
    h3 {
      border-bottom: 3px solid #3498db;
      padding-bottom: 8px;
      margin-bottom: 25px;
      font-size: 1.6rem;
    }
    h4 {
      font-size: 1.25rem;
      color: #2471a3;
      margin-bottom: 12px;
      border-bottom: 1px solid #d6eaf8;
      padding-bottom: 6px;
    }

    /* أقسام الخطة */
    .section {
      margin-bottom: 40px;
      padding-left: 20px;
      border-left: 4px solid #3498db;
      transition: border-color 0.3s ease;
    }
    .section:hover {
      border-color: #2980b9;
    }

    .subsection {
      margin-left: 22px;
      margin-bottom: 28px;
    }

    /* الحقول */
    .field {
      margin-bottom: 18px;
    }
    .field label {
      display: block;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 6px;
      color: #34495e;
      letter-spacing: 0.3px;
    }
    .field span {
      display: block;
      background-color: #f7f9fc;
      border: 1.8px solid #d6e4f0;
      border-radius: 10px;
      padding: 12px 18px;
      font-size: 1rem;
      color: #34495e;
      box-shadow: inset 0 1px 3px rgba(52, 73, 94, 0.1);
      white-space: pre-wrap;
      word-wrap: break-word;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .field span:hover {
      background-color: #eaf3fb;
      border-color: #2980b9;
    }

    /* الروابط */
    a.specialist-link {
      color: #2980b9;
      text-decoration: none;
      font-weight: 700;
      font-size: 1rem;
      border-bottom: 2px solid transparent;
      transition: border-color 0.25s ease, color 0.25s ease;
      cursor: pointer;
      user-select: none;
    }
    a.specialist-link:hover {
      color: #1b4f72;
      border-color: #1b4f72;
    }


    .btn-container {
      text-align: center;
      margin-top: 40px;
    }
    .btn {
      background: linear-gradient(135deg, #2980b9, #3498db);
      color: #fdfdfd;
      font-weight: 700;
      padding: 14px 36px;
      border: none;
      border-radius: 10px;
      font-size: 1.15rem;
      cursor: pointer;
      box-shadow: 0 8px 15px rgba(41, 128, 185, 0.3);
      transition: background 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
    }
    .btn:hover {
      background: linear-gradient(135deg, #1b4f72, #2471a3);
      box-shadow: 0 12px 20px rgba(36, 113, 163, 0.5);
    }

    /* رسائل الخطأ */
    .error {
      color: #e74c3c;
      font-weight: 700;
      text-align: center;
      font-size: 1.1rem;
      padding: 20px 0;
      letter-spacing: 0.5px;
    }

    /* للطباعة */
    @media print {
      body {
        background: white;
        padding: 0;
        color: black;
      }
      .btn-container {
        display: none;
      }
      .container {
        box-shadow: none;
        border: none;
        padding: 0;
        margin: 0;
        width: 100%;
      }
      .section, .subsection, .field {
        page-break-inside: avoid;
      }
      .field span {
        background: white !important;
        border: 1px solid #aaa !important;
        box-shadow: none !important;
      }
      h2, h3, h4 {
        color: black !important;
        text-shadow: none !important;
      }
      a.specialist-link {
        color: black !important;
        text-decoration: underline !important;
        border: none !important;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2 class="logo">Treatment Plan</h2>
  
    <div id="childInfo">
      <strong>Child Basic Info:</strong><br />
      Name: <span id="childName">Loading...</span><br />
      Gender: <span id="childGender">Loading...</span><br />
      Date of Birth: <span id="childDob">Loading...</span><br />
      Age: <span id="childAge">Loading...</span>
    </div>
  
    <div id="planContent">
      <p class="error">Loading treatment plan...</p>
    </div>
  
    <div class="btn-container" id="CreateTretmentPlan" style="display: none;">
      <button onclick="CreateTretmentPlan()" class="btn">Create Treatment Plan</button>
    </div>
  
    <div id="print" class="btn-container">
      <button class="btn" onclick="window.print()">Print</button>
    </div>
  
    <label>Responsible Specialist:</label>
    <p><a id="specialistLink" class="specialist-link" href="#">Loading...</a></p>
  
    <img src="../assets/images/med 1.png" alt="Sky Center Logo" class="logo-img" />
  </div>
  
  <script>
    const currentUserStr = localStorage.getItem('user');
    const currentUser = currentUserStr ? JSON.parse(currentUserStr) : null;
  
    function formatLabel(key) {
      return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
    }
  
    function CreateTretmentPlan() {
      window.location.href = `../Html/CreateTretmentPlan.html?id=${guardianId}`;
    }
  
    function createField(label, value) {
      return `
        <div class="field">
          <label>${label}</label>
          <span>${value ?? 'No data available'}</span>
        </div>
      `;
    }
  
    function renderServices(services) {
      if (!services || services.length === 0) {
        return createField('Services', 'No services added');
      }
      let html = '<section class="section"><h3>Services</h3>';
      services.forEach((service, idx) => {
        html += `<div class="subsection">
          <h4>Service ${idx + 1}</h4>
          ${createField('Service Type', service.type || service.serviceName || '-')}
          ${createField('Notes', service.notes || '-')}
          ${createField('Sessions per Week', service.sessions || '-')}
        </div>`;
      });
      html += '</section>';
      return html;
    }
  
    function renderPlan(plan) {
      if (!plan) return '<p class="error">No treatment plan to display.</p>';
  
      let html = '';
  
      html += `<section class="section">
        <h3>General Information</h3>
        ${createField('Plan Date', plan.plan_date ? new Date(plan.plan_date).toLocaleDateString('en-GB') : '-')}
        ${createField('Diagnosis', plan.diagnosis || '-')}
      </section>`;
  
      if (plan.healthStatus) {
        html += `<section class="section">
          <h3>Health Status</h3>
          ${createField('Hearing', plan.healthStatus.hearing)}
          ${createField('Vision', plan.healthStatus.vision)}
          ${createField('Speech', plan.healthStatus.speech)}
          ${createField('Motor Skills', plan.healthStatus.motor)}
        </section>`;
      }
  
      html += renderServices(plan.services);
  
      html += `<section class="section">
        <h3>Initial Assessment Results</h3>`;
      ['motor', 'selfHelp', 'social', 'cognitive', 'communication'].forEach(domain => {
        const domainData = plan.initialAssessment?.[domain] || {};
        html += `<div class="subsection">
          <h4>${formatLabel(domain)}</h4>
          ${createField('Strengths', domainData.strengths)}
          ${createField('Weaknesses', domainData.weaknesses)}
        </div>`;
      });
      html += `</section>`;
  
      html += `<section class="section">
        <h3>Goals</h3>`;
      ['motor', 'selfHelp', 'social', 'cognitive', 'communication'].forEach(domain => {
        html += createField(formatLabel(domain), plan.goals?.[domain]);
      });
      html += `</section>`;
  
      html += `<section class="section">
        <h3>Team Members</h3>`;
      if (Array.isArray(plan.team) && plan.team.length > 0) {
        plan.team.forEach((member, idx) => {
          html += `<div class="subsection">
            <h4>Member ${idx + 1}</h4>
            ${createField('Name', member.name)}
            ${createField('Role', member.role)}
          </div>`;
        });
      } else {
        html += createField('Team', 'No team members added');
      }
      html += `</section>`;
  
      html += `<section class="section">
        <h3>Approval Date</h3>
        ${createField('Approval Date', plan.approval_date ? new Date(plan.approval_date).toLocaleDateString('en-GB') : 'Not signed yet')}
      </section>`;
  
      return html;
    }
  
    let evaluation = null;
    let guardianId = null;
  
    
async function fetchEvaluation() {
  try {
    const res = await fetch(`http://localhost:4000/api/v1/evaluation/get/${guardianId}`, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    });

    const data = await res.json();
    if (!data.evaluation) {
      if (currentUser?.role === 'specialist') {
        document.getElementById("CreateTretmentPlan").style.display = 'block';
      }
      alert("Evaluation not found yet. Please contact the specialist.");
      document.getElementById("planContent").innerHTML = '';
      return false;
    }

    console.log("Child Evaluation:", data);
    evaluation = data.evaluation;
    const child = evaluation.child || {};

    document.getElementById('childName').textContent = child.fullName || '-';
    document.getElementById('childGender').textContent = (child.gender === 'male' ? 'Male' : (child.gender === 'female' ? 'Female' : '-'));
    document.getElementById('childDob').textContent = child.birthDate ? new Date(child.birthDate).toLocaleDateString('en-GB') : '-';
    document.getElementById('childAge').textContent = child.age || '-';

    return true;

  } catch (error) {
    console.error("Error fetching evaluation:", error);
    alert("An error occurred while loading the evaluation.");
    return false;
  }
}

async function fetchTreatmentPlan() {
  const planContainer = document.getElementById('planContent');
  const specialistLink = document.getElementById('specialistLink');
  const createBtn = document.getElementById('CreateTretmentPlan');

  try {
    const res = await fetch(`http://localhost:4000/api/v1/TreatmentPlan/show/${guardianId}`, {
      headers: {
        Authorization: `Bearer ${localStorage.getItem('token')}`,
      },
    });

    if (res.status === 404) {

  planContainer.innerHTML = `<p class="error">No treatment plan found for this guardian.</p>`;
  specialistLink.textContent = 'Unavailable';
  specialistLink.removeAttribute('href');

  if (currentUser?.role === 'specialist' && evaluation && createBtn) {
    createBtn.style.display = 'block';
  } else if (createBtn) {
    createBtn.style.display = 'none';
  }

  return;
} else if (!res.ok) {
  throw new Error("Failed to fetch treatment plan");
}

    const data = await res.json();
    console.log("Treatment Plan:", data);
    const plan = data.data;

    if (!plan) {
      planContainer.innerHTML = `<p class="error">No treatment plan found for this guardian.</p>`;
      specialistLink.textContent = 'Unavailable';
      specialistLink.removeAttribute('href');

      // ✅ عرض زر إنشاء الخطة فقط إذا المستخدم أخصائي ويوجد تقييم
      if (currentUser?.role === 'specialist' && evaluation && createBtn) {
        createBtn.style.display = 'block';
      } else if (createBtn) {
        createBtn.style.display = 'none';
      }

      return;
    }

    // إذا في خطة علاجية → عرضها وإخفاء الزر
    planContainer.innerHTML = renderPlan(plan);
    if (createBtn) createBtn.style.display = 'none';

    if (plan.createdBy && plan.createdBy.name && plan.createdBy._id) {
      specialistLink.textContent = plan.createdBy.name;
      specialistLink.href = `../Html/viewotherProfile.html?id=${plan.createdBy._id}`;
    } else {
      specialistLink.textContent = 'Unavailable';
      specialistLink.removeAttribute('href');
    }

  } catch (err) {
    planContainer.innerHTML = `<p class="error">An error occurred while loading the treatment plan.</p>`;
    specialistLink.textContent = 'Unavailable';
    specialistLink.removeAttribute('href');
    if (createBtn) createBtn.style.display = 'none';
    console.error(err);
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(window.location.search);
  guardianId = urlParams.get("id");

  if (!guardianId) {
    alert('Guardian ID not found in URL.');
    return;
  }

  const evalSuccess = await fetchEvaluation();

  if (evalSuccess) {
    await fetchTreatmentPlan();
  } else {
    document.getElementById("planContent").innerHTML = `<p class="error">Cannot display treatment plan without evaluation data.</p>`;
    document.getElementById("print").style.display = 'none';
    document.getElementById("specialistLink").textContent = 'Unavailable';
    document.getElementById("specialistLink").removeAttribute('href');
  }
});
  </script>
  
</body>
</html>
